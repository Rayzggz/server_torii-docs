"use strict";(self.webpackChunkserver_torii=self.webpackChunkserver_torii||[]).push([[621],{726:(e,t,a)=>{a.r(t),a.d(t,{comp:()=>r,data:()=>s});var l=a(641);const i={},r=(0,a(262).A)(i,[["render",function(e,t){return(0,l.uX)(),(0,l.CE)("div",null,t[0]||(t[0]=[(0,l.Fv)('<h1 id="外部缓解服务配置" tabindex="-1"><a class="header-anchor" href="#外部缓解服务配置"><span>外部缓解服务配置</span></a></h1><p>本文档详细说明了如何配置和集成外部缓解服务。</p><h2 id="_1-配置参数" tabindex="-1"><a class="header-anchor" href="#_1-配置参数"><span>1. 配置参数</span></a></h2><p>以下是在 Server.yml 启用和配置此功能所需的参数。</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">类型</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;"><code>enabled</code></td><td style="text-align:left;">布尔值</td><td style="text-align:left;"><code>true</code> 或 <code>false</code>，用于开启或关闭此功能。</td></tr><tr><td style="text-align:left;"><code>redirect_url</code></td><td style="text-align:left;">字符串</td><td style="text-align:left;">指定要重定向到的外部验证服务的 URL。</td></tr><tr><td style="text-align:left;"><code>secret_key</code></td><td style="text-align:left;">字符串</td><td style="text-align:left;">用于生成和验证 HMAC 签名的密钥。请确保其足够复杂和安全。</td></tr><tr><td style="text-align:left;"><code>session_timeout</code></td><td style="text-align:left;">整数</td><td style="text-align:left;">指定会话超时时间（以秒为单位）。用户在此时间后需要跳转到外部验证服务重新验证。</td></tr></tbody></table><h2 id="_2-重定向到外部服务" tabindex="-1"><a class="header-anchor" href="#_2-重定向到外部服务"><span>2. 重定向到外部服务</span></a></h2><p>当 Server Torii 将用户重定向到外部服务时，URL 会包含以下查询参数。您需要保存这些参数，以便在外部服务验证用户后能够正确地将其重定向回来。</p><h3 id="查询参数" tabindex="-1"><a class="header-anchor" href="#查询参数"><span>查询参数</span></a></h3><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;"><code>domain</code></td><td style="text-align:left;">原始请求的域名。</td></tr><tr><td style="text-align:left;"><code>session_id</code></td><td style="text-align:left;">Server Torii 生成的会话 ID。</td></tr><tr><td style="text-align:left;"><code>original_uri</code></td><td style="text-align:left;">用户最初尝试访问的 URI。</td></tr><tr><td style="text-align:left;"><code>hmac</code></td><td style="text-align:left;">用于验证请求合法性的 HMAC 签名。</td></tr></tbody></table><h3 id="重定向-url-示例" tabindex="-1"><a class="header-anchor" href="#重定向-url-示例"><span>重定向 URL 示例</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">https://example.com/your-verification-page?domain=your-website.com&amp;session_id=somesessionid&amp;original_uri=%2Fprotected%2Fresource&amp;hmac=abc123xyz456</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="hmac-签名计算" tabindex="-1"><a class="header-anchor" href="#hmac-签名计算"><span>HMAC 签名计算</span></a></h3><p>HMAC 签名用于确保请求的完整性和安全性，必须在外部验证服务端进行严格验证，以防止任意重定向等安全问题。</p><p><strong>计算方法：</strong> 使用 <code>secret_key</code> 创建一个 HMAC（基于 SHA512 算法）对象，然后将 <code>domain</code>、<code>timestampStr</code> 和 <code>original_uri</code> 以冒号（<code>:</code>）拼接后写入 HMAC，用于生成签名。</p><p><strong>示例：</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">hmac = HMAC-SHA512(secretKey, domain + &quot;:&quot; + timestampStr + &quot;:&quot; + originalUri)</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_3-将用户回调到-server-torii" tabindex="-1"><a class="header-anchor" href="#_3-将用户回调到-server-torii"><span>3. 将用户回调到 Server Torii</span></a></h2><p>在您的外部服务完成用户验证后，必须将用户重定向回 Server Torii 的固定回调端点：<code>/torii/external_migration</code>。</p><h3 id="回调参数" tabindex="-1"><a class="header-anchor" href="#回调参数"><span>回调参数</span></a></h3><p>在回调时，您需要在 URL 查询中提供以下参数：</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;"><code>original_uri</code></td><td style="text-align:left;">用户最初请求的原始 URI。</td></tr><tr><td style="text-align:left;"><code>timestamp</code></td><td style="text-align:left;">当前的时间戳。</td></tr><tr><td style="text-align:left;"><code>hmac</code></td><td style="text-align:left;">根据回调参数新生成的 HMAC 签名。</td></tr></tbody></table><h3 id="hmac-签名计算-回调" tabindex="-1"><a class="header-anchor" href="#hmac-签名计算-回调"><span>HMAC 签名计算 (回调)</span></a></h3><p><strong>计算方法：</strong> 使用 <code>secret_key</code> 创建一个 HMAC（基于 SHA512 算法）对象，然后将 <code>sessionID</code>、<code>timestamp</code> 和 <code>original_uri</code> 直接拼接后写入 HMAC，用于生成签名。</p><p><strong>示例：</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">hmac = HMAC-SHA512(secretKey, sessionID + timestamp + original_uri)</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">警告</p><p>为确保安全性和正确性，您必须在计算完 HMAC 后立即将用户重定向回 Server Torii 的回调端点。</p></div>',26)]))}]]),s=JSON.parse('{"path":"/zh/advanced/external_migration.html","title":"外部缓解服务配置","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"1. 配置参数","slug":"_1-配置参数","link":"#_1-配置参数","children":[]},{"level":2,"title":"2. 重定向到外部服务","slug":"_2-重定向到外部服务","link":"#_2-重定向到外部服务","children":[{"level":3,"title":"查询参数","slug":"查询参数","link":"#查询参数","children":[]},{"level":3,"title":"重定向 URL 示例","slug":"重定向-url-示例","link":"#重定向-url-示例","children":[]},{"level":3,"title":"HMAC 签名计算","slug":"hmac-签名计算","link":"#hmac-签名计算","children":[]}]},{"level":2,"title":"3. 将用户回调到 Server Torii","slug":"_3-将用户回调到-server-torii","link":"#_3-将用户回调到-server-torii","children":[{"level":3,"title":"回调参数","slug":"回调参数","link":"#回调参数","children":[]},{"level":3,"title":"HMAC 签名计算 (回调)","slug":"hmac-签名计算-回调","link":"#hmac-签名计算-回调","children":[]}]}],"git":{"updatedTime":1751666849000,"contributors":[{"name":"Rayzggz","username":"Rayzggz","email":"37480123+Rayzggz@users.noreply.github.com","commits":2,"url":"https://github.com/Rayzggz"}],"changelog":[{"hash":"82d290b13e84757735ceffa7ae17e6040ceb13e1","time":1751666849000,"email":"37480123+Rayzggz@users.noreply.github.com","author":"Roi Feng","message":"docs: external migration configuration documentation"},{"hash":"c048890e1f729c2bb40fb069ff30099a264028d6","time":1751498824000,"email":"37480123+Rayzggz@users.noreply.github.com","author":"Roi Feng","message":"docs: 1.1.0"}]},"filePathRelative":"zh/advanced/external_migration.md"}')}}]);